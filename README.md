# Object storage for CakePHP
Библиотека для работы с хранилищем объектов. Позволяет хранить и получать доступ к объектам по ключу.

Имеет под капотом 2 клиента:
* FileClient - хранение объектов в локальной файловой системе (в каталог, определенный константой TMP)
* YandexClient - хранение объектов в YandexStorage

## Подключение к проекту
```bash
composer require eggheads/cakephp-object-storage
```

## Настройка использования
Добавить в файл конфигурации вашего проекта настройки подключения к YandexStorage

```php
'yandexStorage' =>
    'version' => 'latest',
    'endpoint' => 'https://storage.yandexcloud.net',
    'region' => 'ru-central1',
    'credentials' => [
        'key' => '', // Идентификатор клиента
        'secret' => '', // Секретный ключ
        ],
    ],
```

Также есть возможность указать, с каким клиентом будет работать библиотека (по-умолчанию YandexStorage),
для этого в файл конфигурации добавляем параметр:
```php
objectStorageClient => 'FileClient',
```

Таким образом, можно, например, сделать, чтобы по-умолчанию в тестах работал файловый клиент.
Например, добавив в глобальную настройку тестового окружения:
```php
Configure::write('objectStorageClient', 'FileClient');
```

## Использование
В тестах можно мокать методы ObjectStorage, если непосредственно работа с хранилищем не является предметом вашего тестирования.

Если необходимо протестировать полный цикл, то можно переключиться на FileClient (если еще глобально в тестах не переключено).
При этом вся работа с хранилищем будет писаться в лог.

Для запрета записи в лог используйте: `\Eggheads\CakephpObjectStorage\ObjectStorageMock::disableLog`.

## Формирование ключей для бакетов, класс ObjectStorageHelper
```\Eggheads\CakephpObjectStorage\ObjectStorageHelper```

Для хранения файлов в бакете предполагается следующая древовидная структура
* ИД сущности (это может быть идентификатор кабинета или пользователя)
* -- Префикс операции (файлы какого типа мы храним ниже, например cost для себесов, predict - для расчётов поставок)
* ---- Имя файла + случайная примесь (к оригинальному имени файла добавляется уникальная примесь)

ИД сущности и Префикс можно опускать, если это не требуется для задачи

В простейшем варианте, ключ в бакете = имени загруженного файла

Варианты вызовов и получающиеся ключи также можно посмотреть в тесте `\Eggheads\CakephpObjectStorage\Tests\ObjectStorageHelperTest::testGetName`

## Настройки для разработки
В папке config создать файл app_local.php и добавить в него доступ к YandexStorage
